#!/bin/bash -ex
pushd ${BASEDIR}
stage3=$(${PARSERS}/config/getconfig stage3)

stage3_url=$(${PARSERS}/config/getconfig stage3url)
stage3_image=$(wget "${stage3_url}" -O - | sed '/^-----BEGIN PGP SIGNATURE-----$/,$d' | tail -n 1 | cut -f 1 -d ' ' )
stage3_mirror=$(${PARSERS}/config/getconfig stage3mirror)
stage3_digests=$(wget ${stage3_mirror}/${stage3_image}.DIGESTS -O -)

if [ -f "${BINARY_ASSETS}/stage3/${stage3}" ]
then
    if diff "${BINARY_ASSETS}/stage3/${stage3}.DIGESTS" - <<< "${stage3_digests}"
	then
        exit 0
    else
        echo "stage3 digest indicates stage3 image is out of date, removing and re-downloading."
        rm -rf "${BINARY_ASSETS}/stage3/"
    fi
fi

mkdir -p "${BINARY_ASSETS}/stage3/"

cat <<<"${stage3_digests}" > "${BINARY_ASSETS}/stage3/${stage3}.DIGESTS"

# Download with retry on failure
for attempt in 1 2; do
    wget ${stage3_mirror}/${stage3_image} -O "${BINARY_ASSETS}/stage3/${stage3}"

    # Verify the downloaded file is valid
    if [ ! -f "${BINARY_ASSETS}/stage3/${stage3}" ] || [ ! -s "${BINARY_ASSETS}/stage3/${stage3}" ]; then
        echo "ERROR: Downloaded stage3 file is missing or empty (attempt $attempt)"
        rm -f "${BINARY_ASSETS}/stage3/${stage3}"
        [ $attempt -eq 2 ] && exit 1
        continue
    fi

    # Verify digest of downloaded file
    expected_hash=$(grep -A1 "SHA512 HASH" "${BINARY_ASSETS}/stage3/${stage3}.DIGESTS" | tail -n1 | awk '{print $1}')
    actual_hash=$(sha512sum "${BINARY_ASSETS}/stage3/${stage3}" | awk '{print $1}')
    if [ "$expected_hash" != "$actual_hash" ]; then
        echo "ERROR: Downloaded stage3 file failed SHA512 verification (attempt $attempt)"
        rm -f "${BINARY_ASSETS}/stage3/${stage3}"
        [ $attempt -eq 2 ] && exit 1
        continue
    fi

    # Success
    break
done
